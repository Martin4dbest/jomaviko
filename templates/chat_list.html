<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Select User to Chat</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js for lightweight UI state -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <!-- Bootstrap Icons (for chat icon) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    /* small helper to clamp last-message preview */
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <div class="max-w-4xl mx-auto p-6" x-data="chatList()" x-init="init()">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-extrabold">
          {% if current_user.role == 'seller' %}
            Chat with Admin
          {% elif current_user.role == 'admin' %}
            Chat with a Seller
          {% else %}
            Start a Chat
          {% endif %}
        </h1>
        <p class="text-sm text-gray-500 mt-1">Select a user to open a one-to-one conversation. Use search or keyboard navigation.</p>
      </div>

      <div class="flex items-center gap-2">
        <label for="search" class="sr-only">Search users</label>
        <input id="search" x-model.debounce.250ms="query" type="search" placeholder="Search by name, location or username..." class="w-64 px-3 py-2 rounded-lg border border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-400" />

        <button @click="refresh()" class="inline-flex items-center gap-2 bg-white border rounded-lg px-3 py-2 shadow-sm hover:bg-gray-100">
          <i class="bi bi-arrow-clockwise"></i>
          <span class="text-sm">Refresh</span>
        </button>

        <div class="hidden sm:block text-xs text-gray-500">Last sync: <span x-text="lastSync || '-' "></span></div>
      </div>
    </div>

    <!-- Controls: sort & filters -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <select x-model="sortBy" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm">
          <option value="recent">Most Recent</option>
          <option value="unread">Unread First</option>
          <option value="online">Online First</option>
        </select>

        <button @click="toggleCompact()" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm">Toggle Compact</button>
      </div>

      <div class="text-sm text-gray-500">Showing <span x-text="visibleCount"></span> users</div>
    </div>

    <!-- User list (grid on wide screens) -->
    <div id="userList" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      {% for user in target_users %}
      <a href="{{ url_for('chat_with_user', user_id=user.id) }}"
         class="user-card group block bg-white border border-gray-100 rounded-lg p-4 shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-teal-300"
         data-user-id="{{ user.id }}"
         data-username="{{ user.username|lower }}"
         data-location="{{ (user.location or '')|lower }}"
         data-last-message="{{ (user.last_message or '')|e('js') }}"
         data-last-active="{{ user.last_active.isoformat() if user.last_active is defined and user.last_active else '' }}"
         tabindex="0"
         role="link"
         aria-label="Chat with {{ user.username }}">

        <div class="flex items-start gap-3">
          <!-- Avatar -->
          <div class="flex-shrink-0 relative">
            {% if user.avatar_url %}
            <img src="{{ user.avatar_url }}" alt="{{ user.username }} avatar" class="w-12 h-12 rounded-full object-cover border" />
            {% else %}
            <div class="w-12 h-12 rounded-full bg-teal-500 flex items-center justify-center text-white font-bold text-lg">{{ user.username[0] }}</div>
            {% endif %}

            <!-- online dot (updated by JS) -->
            <span class="online-dot absolute -bottom-0.5 -right-0.5 block w-3 h-3 rounded-full ring-2 ring-white" style="display:none; background-color:#34D399"></span>
          </div>

          <!-- Body -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between gap-2">
              <div class="truncate">
                <div class="font-semibold text-gray-900 group-hover:text-teal-600" data-username-display>{{ user.username }}</div>
                <div class="text-xs text-gray-500" data-location-display>{{ user.location or '' }}</div>
              </div>

              <div class="text-right flex-shrink-0">
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-400" data-last-active>
                    {% if user.last_active %}{{ user.last_active.strftime('%b %d') }}{% endif %}
                  </span>

                  <!-- unread badge -->
                  {% if unread_counts.get(user.id, 0) > 0 %}
                  <span class="inline-flex items-center justify-center bg-red-600 text-white text-xs px-2 py-0.5 rounded-full" data-unread="{{ unread_counts[user.id] }}">{{ unread_counts[user.id] }}</span>
                  {% else %}
                  <span class="inline-flex items-center justify-center bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full" data-unread="0" style="display:none;">0</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- last message preview -->
            <div class="mt-2 text-sm text-gray-600 line-clamp-2" data-last-message-display>
              {{ user.last_message or 'No messages yet' }}
            </div>
          </div>
        </div>
      </a>
      {% endfor %}
    </div>

    <!-- Empty state -->
    {% if not target_users %}
    <div class="text-center py-12 text-gray-500">
      No users available to chat. Try refreshing or check your permissions.
    </div>
    {% endif %}

    <!-- Footer actions -->
    <div class="mt-6 text-center">
      <a href="{{ url_for('index') }}" class="text-sm text-gray-600 hover:text-gray-800">‚Üê Return to Dashboard</a>
    </div>

  </div>

  <!-- Script: client-side filtering, keyboard nav, polling unread/online counts -->
  <script>
    function chatList() {
      return {
        query: '',
        sortBy: 'recent',
        compact: false,
        lastSync: '',
        pollInterval: 9000, // ms
        visibleCount: 0,

        init() {
          // initial render
          this.applyFilters();

          // keyboard: Enter on card opens link
          document.querySelectorAll('.user-card').forEach(el => {
            el.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') window.location = el.getAttribute('href');
            });
          });

          // start polling for unread/unline counts
          this.poll();
          this._poller = setInterval(() => this.poll(), this.pollInterval);

          // reactive watchers
          this.$watch('query', () => this.debouncedApply());
          this.$watch('sortBy', () => this.applyFilters());
          this.$watch('compact', () => this.applyCompact());
        },

        debouncedApply: (function () {
          let timeout = null;
          return function () {
            clearTimeout(timeout);
            timeout = setTimeout(() => this.applyFilters(), 180);
          };
        })(),

        applyFilters() {
          const q = (this.query || '').trim().toLowerCase();
          const cards = Array.from(document.querySelectorAll('.user-card'));

          let visible = cards.filter(card => {
            const username = card.dataset.username || '';
            const location = card.dataset.location || '';
            const lastMsg = (card.dataset.lastMessage || '').toLowerCase();
            if (!q) return true;
            return username.includes(q) || location.includes(q) || lastMsg.includes(q);
          });

          // Sorting
          if (this.sortBy === 'unread') {
            visible.sort((a,b) => (parseInt(b.querySelector('[data-unread]').dataset.unread || 0) - parseInt(a.querySelector('[data-unread]').dataset.unread || 0)));
          } else if (this.sortBy === 'online') {
            visible.sort((a,b) => ((b.querySelector('.online-dot')?.style.display === 'block') ? 1 : 0) - ((a.querySelector('.online-dot')?.style.display === 'block') ? 1 : 0));
          } // recent relies on server ordering

          // Re-attach in order
          const container = document.getElementById('userList');
          visible.forEach(v => container.appendChild(v));

          // hide non visible
          cards.forEach(c => c.style.display = visible.includes(c) ? '' : 'none');

          this.visibleCount = visible.length;
        },

        applyCompact() {
          document.querySelectorAll('.user-card').forEach(c => {
            c.classList.toggle('p-2', this.compact);
            c.classList.toggle('text-sm', this.compact);
          });
        },

        toggleCompact() { this.compact = !this.compact; },

        refresh() { this.poll(); this.applyFilters(); },

        async poll() {
          this.lastSync = new Date().toLocaleTimeString();
          // fetch unread counts
          try {
            const res = await fetch('/api/unread_counts');
            if (res.ok) {
              const data = await res.json(); // expected: { "<user_id>": <count>, ... }
              for (const [id, count] of Object.entries(data)) {
                const card = document.querySelector(`.user-card[data-user-id='${id}']`);
                if (!card) continue;
                const badge = card.querySelector('[data-unread]');
                if (badge) {
                  badge.dataset.unread = count;
                  badge.textContent = count;
                  badge.style.display = count > 0 ? '' : 'none';
                }
              }
            }
          } catch (e) { /* silent */ }

          // fetch online status
          try {
            const res2 = await fetch('/api/online_status');
            if (res2.ok) {
              const data2 = await res2.json(); // expected: { "<user_id>": true/false, ... }
              for (const [id, online] of Object.entries(data2)) {
                const card = document.querySelector(`.user-card[data-user-id='${id}']`);
                if (!card) continue;
                const dot = card.querySelector('.online-dot');
                if (dot) dot.style.display = online ? 'block' : 'none';
              }
            }
          } catch (e) { /* silent */ }
        }
      };
    }
  </script>

</body>
</html>